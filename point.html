<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shuttle Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Kanit', sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .card {
            background: white;
            width: 100%;
            max-width: 380px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            padding: 25px;
            padding-bottom: 50px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .header h2 { margin: 0; font-size: 20px; color: #202124; font-weight: 700; }
        .live-badge {
            background: #e8f0fe; color: #1a73e8; padding: 4px 8px; 
            border-radius: 4px; font-size: 10px; font-weight: bold; letter-spacing: 0.5px;
        }

        .timeline { position: relative; padding-left: 10px; margin-top: 10px; }
        .timeline::before {
            content: ''; position: absolute; left: 24px; top: 15px; bottom: 30px;
            width: 2px; background: #e8eaed; z-index: 0;
        }

        .stop-item {
            position: relative; display: flex; align-items: flex-start;
            margin-bottom: 30px; z-index: 1; min-height: 40px;
        }

        /* Marker ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏°) */
        .marker {
            width: 30px; height: 30px; border-radius: 50%; background: white;
            border: 2px solid #e8eaed; display: flex; align-items: center; justify-content: center;
            margin-right: 15px; flex-shrink: 0; position: relative;
        }
        .circle-dot { width: 8px; height: 8px; background: #e8eaed; border-radius: 50%; }

        /* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
        .content h3 { margin: 0; font-size: 15px; color: #3c4043; font-weight: 500; line-height: 1.4; }
        .content p { margin: 2px 0 0; font-size: 12px; color: #9aa0a6; }

        /* --- STYLES ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏£‡∏ñ --- */
        .van-badge {
            position: absolute; left: 45px; top: -25px; /* ‡∏•‡∏≠‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ */
            padding: 4px 10px; border-radius: 15px;
            font-size: 11px; font-weight: bold; color: white;
            display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
            transition: top 0.3s ease;
        }

        /* Van 1 : ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô */
        .van1-badge { background: #1a73e8; }
        /* Van 2 : ‡∏™‡∏µ‡∏™‡πâ‡∏° */
        .van2-badge { background: #f57c00; top: -25px; right: 0; left: auto; /* Van 2 ‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤ */ }

        /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏ñ‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ */
        .active-stop .marker { border-color: #1a73e8; background: #fff; }
        .active-stop .content h3 { color: #202124; font-weight: 700; }
        .active-stop .circle-dot { background: #1a73e8; transform: scale(1.2); }

    </style>
</head>
<body>

    <div class="card">
        <div class="header">
            <h2>Shuttle Route</h2>
            <span class="live-badge">LIVE ‚Ä¢ <span id="active-count">0</span> Vans</span>
        </div>

        <div class="timeline" id="timeline-container">
            Loading...
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBL4nhltSeXZTtgShoqgvWG4tcyb92XOzw",
            authDomain: "my-apartment-shuttle.firebaseapp.com",
            databaseURL: "https://my-apartment-shuttle-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "my-apartment-shuttle",
            storageBucket: "my-apartment-shuttle.firebasestorage.app",
            messagingSenderId: "808566202899",
            appId: "1:808566202899:web:5626ae23c0df6335d455e6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ
        const stations = [
            { name: "Salaya One Hotel & Serviced Apartment", lat: 13.801307528476485, lng: 100.31184859685465 },//13.801307528476485, 100.31184859685465
            { name: "1.College of Music", lat: 13.788904728829397, lng: 100.32389069925281 },
            { name: "2.1 Faculty of Science 3", lat: 13.793003329175068, lng: 100.32209472460619 }, //13.793003329175068, 100.32209472460619
            { name: "2.2 Faculty of Science 2", lat: 13.792808930787233, lng: 100.3232846273437 }, //13.792808930787233, 100.3232846273437
            { name: "3. Faculty of Social Sciences and Humanities", lat: 13.792213752692787, lng: 100.32486876253822 }, //13.792213752692787, 100.32486876253822
            { name: "4. New MUIC Building", lat: 13.790603615089555, lng: 100.32642917272868 },//
            { name: "5. Old MUIC Building", lat: 13.792825444200497, lng: 100.32604719730193 },//
            { name: "6. Campus Building", lat: 13.793753432988641, lng: 100.32480465775636 },//13.793753432988641, 100.32480465775636
            { name: "7. Faculty of Engineering", lat: 13.796311283547787, lng: 100.32491359376786 },//13.796311283547787, 100.32491359376786
            { name: "8. ICT", lat: 13.7944683388828, lng: 100.32470635179706 },//13.7944683388828, 100.32470635179706
            { name: "9. Faculty of Medical Technology", lat: 13.797597784507522, lng: 100.3220243967522 },//13.797597784507522, 100.3220243967522
            { name: "10. Physical and Medical Technology Building", lat: 13.798710641549654, lng: 100.32308905165148 },//13.798710641549654, 100.32308905165148
            { name: "11. Faculty of Liberal Arts", lat: 13.79728207941215, lng: 100.32091504261966 },//13.79728207941215, 100.32091504261966
            { name: "12. Electric Mini-Bus", lat: 13.794816858149446, lng: 100.31883868060257 },//13.794816858149446, 100.31883868060257
            { name: "13. Faculty of Veterinary Science", lat: 13.798234387105726, lng: 100.3177604325669 },//13.798234387105726, 100.3177604325669
            { name: "14. MUIDS", lat: 13.799975002826338, lng: 100.32363233570953 }//13.799975002826338, 100.32363233570953
        ];

        // Render ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        const container = document.getElementById('timeline-container');
        function renderRoute() {
            container.innerHTML = '';
            stations.forEach((st, index) => {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á div ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö van badges ‡πÅ‡∏ö‡∏ö dynamic
                container.innerHTML += `
                    <div class="stop-item" id="stop-${index}">
                        <div class="marker">
                            <div class="circle-dot"></div>
                        </div>
                        <div class="content" style="flex-grow:1; position:relative;">
                            <div id="badge-area-${index}"></div>
                            
                            <h3>${st.name}</h3>
                        </div>
                    </div>
                `;
            });
        }
        renderRoute();

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- REALTIME LOGIC ---
        // ‡∏ü‡∏±‡∏á‡∏ó‡∏µ‡πà root 'shuttles' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á van1 ‡πÅ‡∏•‡∏∞ van2
        db.ref('shuttles').on('value', (snapshot) => {
            const allVans = snapshot.val();
            let activeCount = 0;

            // 1. Clear ‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏ñ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
            document.querySelectorAll('.van-badge').forEach(el => el.remove());
            document.querySelectorAll('.stop-item').forEach(el => el.classList.remove('active-stop'));

            if (allVans) {
                // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏±‡∏ô (key ‡∏Ñ‡∏∑‡∏≠ van1, van2)
                Object.keys(allVans).forEach(vanKey => {
                    const vanData = allVans[vanKey];

                    // ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏ñ Active ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á)
                    if (vanData.active) {
                        activeCount++;
                        
                        // ‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                        let minDist = Infinity;
                        let closestIdx = -1;

                        stations.forEach((st, idx) => {
                            const d = getDistance(vanData.lat, vanData.lng, st.lat, st.lng);
                            if (d < minDist) {
                                minDist = d;
                                closestIdx = idx;
                            }
                        });

                        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                        if (closestIdx !== -1) {
                            const badgeArea = document.getElementById(`badge-area-${closestIdx}`);
                            const stopItem = document.getElementById(`stop-${closestIdx}`);
                            
                            // Highlight ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ
                            stopItem.classList.add('active-stop');

                            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ
                            const badge = document.createElement('div');
                            badge.className = `van-badge ${vanKey}-badge`; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ van
                            
                            // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏õ‡πâ‡∏≤‡∏¢
                            let statusText = "Arrived";
                            if (minDist > 100) statusText = "Near"; 
                            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏ñ + ‡∏ä‡∏∑‡πà‡∏≠
                            badge.innerHTML = `üöå ${vanKey.toUpperCase()} <span style="font-weight:400; opacity:0.8; margin-left:3px; font-size:9px;">(${statusText})</span>`;
                            
                            badgeArea.appendChild(badge);
                        }
                    }
                });
            }
            
            document.getElementById('active-count').innerText = activeCount;
        });
    </script>
</body>
</html>
